<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>ChordFlow — Beautiful Chord Sheets</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Crimson+Pro:wght@400;600&family=JetBrains+Mono:wght@500&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #faf8f5;
      --text: #2a2522;
      --muted: #8a8580;
      --accent: #c45d4a;
      --border: #e8e4df;
      --input-bg: #fff;
      
      --chord-1: #c45d4a;
      --chord-2: #4a7c59;
      --chord-3: #6b5b95;
      --chord-4: #d4a84b;
      --chord-5: #3d7ea6;
      --chord-6: #9b4d6a;
      --chord-7: #5d8aa8;
      --chord-8: #b5651d;
      --chord-9: #2e8b57;
      --chord-10: #8b4513;
      --chord-11: #6a5acd;
      --chord-12: #cd853f;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Crimson Pro', Georgia, serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      line-height: 1.5;
    }

    /* Editor Mode */
    .editor-container {
      max-width: 800px;
      margin: 0 auto;
      padding: 2rem 1.5rem;
    }

    .header { text-align: center; margin-bottom: 1.5rem; }

    .logo {
      font-family: 'Playfair Display', serif;
      font-size: 2.5rem;
      font-weight: 700;
      color: var(--text);
      letter-spacing: -0.02em;
    }

    .logo span { color: var(--accent); }

    .tagline {
      color: var(--muted);
      font-size: 1.1rem;
      margin-top: 0.25rem;
    }

    .input-section { margin-bottom: 1rem; }

    .input-section label {
      display: block;
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.75rem;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: var(--muted);
      margin-bottom: 0.5rem;
    }

    .title-input, .notes-input {
      width: 100%;
      padding: 0.75rem 1rem;
      font-family: 'Playfair Display', serif;
      font-size: 1.25rem;
      border: 1px solid var(--border);
      border-radius: 6px;
      background: var(--input-bg);
      color: var(--text);
    }

    .notes-input {
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.9rem;
    }

    .title-input:focus, .notes-input:focus { outline: none; border-color: var(--accent); }

    .row { display: flex; gap: 1rem; }
    .row > * { flex: 1; }

    textarea {
      width: 100%;
      min-height: 280px;
      padding: 1rem;
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.9rem;
      line-height: 1.8;
      border: 1px solid var(--border);
      border-radius: 6px;
      background: var(--input-bg);
      color: var(--text);
      resize: vertical;
    }

    textarea:focus { outline: none; border-color: var(--accent); }
    textarea::placeholder { color: var(--muted); }

    .actions { display: flex; gap: 1rem; flex-wrap: wrap; margin-bottom: 1.5rem; }

    .btn {
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.8rem;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .btn-primary { background: var(--accent); color: #fff; }
    .btn-primary:hover { background: #b04d3a; transform: translateY(-1px); }

    .btn-secondary {
      background: var(--input-bg);
      color: var(--text);
      border: 1px solid var(--border);
    }
    .btn-secondary:hover { background: var(--bg); border-color: var(--muted); }

    .keyboard-hint {
      font-size: 0.8rem;
      color: var(--muted);
      text-align: center;
    }

    kbd {
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.75rem;
      background: var(--input-bg);
      border: 1px solid var(--border);
      border-radius: 3px;
      padding: 0.15em 0.4em;
      box-shadow: 0 1px 0 var(--border);
    }

    /* Documentation Section */
    .docs {
      margin-top: 2rem;
      border-top: 1px solid var(--border);
      padding-top: 1.5rem;
    }

    .docs-toggle {
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
      padding: 0.5rem 0;
    }

    .docs-toggle h2 {
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.75rem;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: var(--muted);
    }

    .docs-toggle .arrow {
      color: var(--muted);
      transition: transform 0.2s;
    }

    .docs.open .arrow { transform: rotate(180deg); }

    .docs-content {
      display: none;
      padding-top: 1rem;
    }

    .docs.open .docs-content { display: block; }

    .docs-content h3 {
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.7rem;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: var(--accent);
      margin: 1.25rem 0 0.5rem 0;
    }

    .docs-content h3:first-child { margin-top: 0; }

    .docs-content p {
      font-size: 0.95rem;
      color: var(--text);
      margin-bottom: 0.5rem;
    }

    .docs-content code {
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.85rem;
      background: var(--input-bg);
      padding: 0.15em 0.4em;
      border-radius: 4px;
      color: var(--accent);
      border: 1px solid var(--border);
    }

    .docs-content code.muted { color: var(--muted); }

    .example-block {
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.8rem;
      background: var(--input-bg);
      padding: 0.75rem 1rem;
      border-radius: 6px;
      margin: 0.75rem 0;
      white-space: pre-wrap;
      color: var(--text);
      border: 1px solid var(--border);
    }

    .example-block .comment { color: var(--muted); }

    /* Display Mode */
    .display-container {
      display: none;
      padding: 1rem;
      min-height: 100vh;
    }

    .display-container.active { display: block; }
    .editor-container.hidden { display: none; }

    .display-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.5rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid var(--border);
      gap: 0.5rem;
    }

    .song-info { flex: 1; min-width: 0; }

    .song-title {
      font-family: 'Playfair Display', serif;
      font-size: 1.5rem;
      font-weight: 700;
      line-height: 1.2;
    }

    .song-notes {
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.7rem;
      color: var(--muted);
      margin-top: 0.2rem;
    }

    .header-controls {
      display: flex;
      gap: 0.5rem;
      flex-shrink: 0;
    }

    .icon-btn {
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.65rem;
      text-transform: uppercase;
      letter-spacing: 0.03em;
      padding: 0.4rem 0.6rem;
      background: transparent;
      border: 1px solid var(--border);
      border-radius: 4px;
      cursor: pointer;
      color: var(--muted);
      transition: all 0.2s ease;
    }

    .icon-btn:hover { border-color: var(--text); color: var(--text); }
    .icon-btn.active { background: var(--text); color: var(--bg); border-color: var(--text); }

    /* Chord Diagrams Panel */
    .chord-diagrams {
      display: none;
      flex-wrap: wrap;
      gap: 0.75rem;
      padding: 0.75rem;
      background: rgba(0,0,0,0.02);
      border-radius: 6px;
      margin-bottom: 0.75rem;
    }

    .chord-diagrams.visible { display: flex; }

    .chord-diagram { text-align: center; }
    .chord-diagram svg { display: block; }

    .chord-diagram-label {
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.7rem;
      font-weight: 500;
      margin-top: 0.2rem;
    }

    /* Chord Legend */
    .chord-legend {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-bottom: 0.75rem;
      padding: 0.5rem 0.75rem;
      background: rgba(0,0,0,0.02);
      border-radius: 6px;
    }

    .legend-item {
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.75rem;
      font-weight: 500;
      padding: 0.2rem 0.4rem;
      border-radius: 3px;
      background: var(--input-bg);
      border: 1px solid var(--border);
    }

    /* Chord Sheet */
    .chord-sheet {
      column-width: 280px;
      column-gap: 2rem;
      column-rule: 1px solid var(--border);
    }

    .chord-sheet.paging-mode {
      column-width: unset;
      column-gap: unset;
      column-rule: none;
    }

    .line {
      break-inside: avoid;
      margin-bottom: 0.4rem;
      page-break-inside: avoid;
    }

    .line.empty {
      height: 0.3rem;
      margin-bottom: 0.2rem;
    }

    .section-marker {
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.6rem;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--muted);
      margin: 0.5rem 0 0.15rem 0;
      padding: 0;
      break-after: avoid;
    }

    .section-marker::before {
      content: '— ';
      opacity: 0.5;
    }

    .chord-line {
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.8rem;
      font-weight: 500;
      height: 1.1em;
      position: relative;
      white-space: pre;
    }

    .chord {
      position: absolute;
      transform: translateX(-0.1em);
    }

    .lyric-line {
      font-size: 1.05rem;
      white-space: pre-wrap;
      word-wrap: break-word;
      line-height: 1.35;
    }

    .colored-text { transition: color 0.15s ease; }

    /* Paging Mode */
    .page-section { display: none; }
    .page-section.active { display: block; }

    .paging-controls {
      display: none;
      position: fixed;
      bottom: 1rem;
      left: 50%;
      transform: translateX(-50%);
      background: var(--input-bg);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 0.5rem 1rem;
      box-shadow: 0 2px 12px rgba(0,0,0,0.1);
      z-index: 100;
    }

    .paging-controls.visible { display: flex; align-items: center; gap: 1rem; }

    .page-indicator {
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.75rem;
      color: var(--muted);
    }

    .page-nav {
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.8rem;
      padding: 0.3rem 0.6rem;
      background: transparent;
      border: 1px solid var(--border);
      border-radius: 4px;
      cursor: pointer;
      color: var(--text);
    }

    .page-nav:hover { background: var(--bg); }
    .page-nav:disabled { opacity: 0.3; cursor: default; }

    /* Print Styles */
    @media print {
      body { background: #fff; }
      .header-controls, .paging-controls { display: none !important; }
      .display-header { border-bottom: 1px solid #ccc; }
      .chord-sheet { column-width: 250px; }
      .chord-legend, .chord-diagrams { background: none; border: 1px solid #ddd; }
    }

    @media (max-width: 600px) {
      .editor-container { padding: 1rem; }
      .logo { font-size: 2rem; }
      .song-title { font-size: 1.25rem; }
      .chord-sheet { column-width: 100%; }
      .display-container { padding: 0.75rem; }
      .row { flex-direction: column; gap: 0; }
    }
  </style>
</head>
<body>
  <div class="editor-container" id="editor">
    <header class="header">
      <h1 class="logo">Chord<span>Flow</span></h1>
      <p class="tagline">Beautiful, printable chord sheets</p>
    </header>

    <div class="input-section">
      <div class="row">
        <div>
          <label for="title">Song Title</label>
          <input type="text" id="title" class="title-input" placeholder="Song title...">
        </div>
        <div>
          <label for="notes">Notes (tuning, capo, etc.)</label>
          <input type="text" id="notes" class="notes-input" placeholder="e.g. Capo 2, Tuning: Drop D">
        </div>
      </div>
    </div>

    <div class="input-section">
      <label for="lyrics">Chords & Lyrics</label>
      <textarea id="lyrics" placeholder="{Verse 1}
[D] Living on the road my friend
[A] Was gonna keep you free and clean

{Chorus}
[G] All the federales say..."></textarea>
    </div>

    <div class="actions">
      <button class="btn btn-primary" id="displayBtn">Display Chord Sheet</button>
      <button class="btn btn-secondary" id="clearBtn">Clear</button>
    </div>

    <p class="keyboard-hint"><kbd>Ctrl</kbd> + <kbd>Enter</kbd> to display · <kbd>Esc</kbd> to edit</p>

    <div class="docs" id="docs">
      <div class="docs-toggle" id="docsToggle">
        <h2>Format Reference</h2>
        <span class="arrow">▼</span>
      </div>
      <div class="docs-content">
        <h3>Chords</h3>
        <p>Place chords in <code>[square brackets]</code> directly before the syllable where the chord should be played.</p>
        <div class="example-block">[G]You weren't your mama's only boy
But her fav[D]orite one [G]it seems</div>
        <p>Chords will appear above the lyrics, and the text following each chord will be colored to match.</p>

        <h3>Sections</h3>
        <p>Use <code class="muted">{curly braces}</code> on their own line to mark song sections.</p>
        <div class="example-block">{Verse 1}
[D]Living on the road my friend

{Chorus}
[G]All the federales say</div>
        <p>In <strong>Page Mode</strong>, each section becomes its own page for hands-free navigation.</p>

        <h3>Instrumental Breaks</h3>
        <p>For chord-only lines (intros, outros, turnarounds), just write chords without lyrics:</p>
        <div class="example-block">{Intro}
[D] [A] [G] [D]

{Turnaround}
[D4] [D] [D4]</div>

        <h3>Page Mode</h3>
        <p>Click <strong>Pages</strong> to enter presentation mode. Navigate with:</p>
        <p>• Tap/click the screen</p>
        <p>• <kbd>Space</kbd> or <kbd>→</kbd> for next page</p>
        <p>• <kbd>←</kbd> for previous page</p>

        <h3>Supported Chords</h3>
        <p>Diagrams are available for: A, Am, A7, Am7, B, Bm, B7, C, Cm, C7, D, Dm, D7, D4, Dsus2, E, Em, E7, F, Fm, F7, G, Gm, G7, G4, and more. Unknown chords will still display in the legend with colors.</p>
      </div>
    </div>
  </div>

  <div class="display-container" id="display">
    <div class="display-header">
      <div class="song-info">
        <h1 class="song-title" id="songTitle">Song Title</h1>
        <div class="song-notes" id="songNotes"></div>
      </div>
      <div class="header-controls">
        <button class="icon-btn" id="diagramsBtn" title="Toggle chord diagrams">Chords</button>
        <button class="icon-btn" id="pagingBtn" title="Toggle paging mode">Pages</button>
        <button class="icon-btn" id="backBtn">← Edit</button>
      </div>
    </div>
    <div class="chord-diagrams" id="chordDiagrams"></div>
    <div class="chord-legend" id="legend"></div>
    <div class="chord-sheet" id="chordSheet"></div>
    <div class="paging-controls" id="pagingControls">
      <button class="page-nav" id="prevPage">‹ Prev</button>
      <span class="page-indicator" id="pageIndicator">1 / 1</span>
      <button class="page-nav" id="nextPage">Next ›</button>
    </div>
  </div>

  <script>
    const CHORD_COLORS = [
      '#c45d4a', '#4a7c59', '#6b5b95', '#d4a84b', '#3d7ea6',
      '#9b4d6a', '#5d8aa8', '#b5651d', '#2e8b57', '#8b4513',
      '#6a5acd', '#cd853f'
    ];

    // Extended chord diagram library
    const CHORD_DIAGRAMS = {
      // A chords
      'A':     { frets: [null, 0, 2, 2, 2, 0], startFret: 1 },
      'Am':    { frets: [null, 0, 2, 2, 1, 0], startFret: 1 },
      'A7':    { frets: [null, 0, 2, 0, 2, 0], startFret: 1 },
      'Am7':   { frets: [null, 0, 2, 0, 1, 0], startFret: 1 },
      'Amaj7': { frets: [null, 0, 2, 1, 2, 0], startFret: 1 },
      'A4':    { frets: [null, 0, 2, 2, 3, 0], startFret: 1 },
      'Asus4': { frets: [null, 0, 2, 2, 3, 0], startFret: 1 },
      'Asus2': { frets: [null, 0, 2, 2, 0, 0], startFret: 1 },
      'A2':    { frets: [null, 0, 2, 2, 0, 0], startFret: 1 },
      
      // B chords
      'B':     { frets: [null, 2, 4, 4, 4, 2], startFret: 1, barre: 2 },
      'Bm':    { frets: [null, 2, 4, 4, 3, 2], startFret: 1, barre: 2 },
      'B7':    { frets: [null, 2, 1, 2, 0, 2], startFret: 1 },
      
      // C chords
      'C':     { frets: [null, 3, 2, 0, 1, 0], startFret: 1 },
      'Cm':    { frets: [null, 3, 5, 5, 4, 3], startFret: 3, barre: 3 },
      'C7':    { frets: [null, 3, 2, 3, 1, 0], startFret: 1 },
      'Cmaj7': { frets: [null, 3, 2, 0, 0, 0], startFret: 1 },
      'Cadd9': { frets: [null, 3, 2, 0, 3, 0], startFret: 1 },
      
      // D chords
      'D':     { frets: [null, null, 0, 2, 3, 2], startFret: 1 },
      'Dm':    { frets: [null, null, 0, 2, 3, 1], startFret: 1 },
      'D7':    { frets: [null, null, 0, 2, 1, 2], startFret: 1 },
      'Dmaj7': { frets: [null, null, 0, 2, 2, 2], startFret: 1 },
      'D4':    { frets: [null, null, 0, 2, 3, 3], startFret: 1 },
      'Dsus4': { frets: [null, null, 0, 2, 3, 3], startFret: 1 },
      'Dsus2': { frets: [null, null, 0, 2, 3, 0], startFret: 1 },
      'D2':    { frets: [null, null, 0, 2, 3, 0], startFret: 1 },
      'Dadd4': { frets: [null, null, 0, 2, 3, 3], startFret: 1 },
      
      // E chords
      'E':     { frets: [0, 2, 2, 1, 0, 0], startFret: 1 },
      'Em':    { frets: [0, 2, 2, 0, 0, 0], startFret: 1 },
      'E7':    { frets: [0, 2, 0, 1, 0, 0], startFret: 1 },
      'Em7':   { frets: [0, 2, 0, 0, 0, 0], startFret: 1 },
      'Emaj7': { frets: [0, 2, 1, 1, 0, 0], startFret: 1 },
      'E4':    { frets: [0, 2, 2, 2, 0, 0], startFret: 1 },
      'Esus4': { frets: [0, 2, 2, 2, 0, 0], startFret: 1 },
      
      // F chords
      'F':     { frets: [1, 3, 3, 2, 1, 1], startFret: 1, barre: 1 },
      'Fm':    { frets: [1, 3, 3, 1, 1, 1], startFret: 1, barre: 1 },
      'F7':    { frets: [1, 3, 1, 2, 1, 1], startFret: 1, barre: 1 },
      'Fmaj7': { frets: [null, null, 3, 2, 1, 0], startFret: 1 },
      
      // G chords
      'G':     { frets: [3, 2, 0, 0, 0, 3], startFret: 1 },
      'Gm':    { frets: [3, 5, 5, 3, 3, 3], startFret: 3, barre: 3 },
      'G7':    { frets: [3, 2, 0, 0, 0, 1], startFret: 1 },
      'Gmaj7': { frets: [3, 2, 0, 0, 0, 2], startFret: 1 },
      'G4':    { frets: [3, 2, 0, 0, 1, 3], startFret: 1 },
      'Gsus4': { frets: [3, 2, 0, 0, 1, 3], startFret: 1 },
      'Gsus2': { frets: [3, 2, 0, 0, 0, 0], startFret: 1 },
      'G2':    { frets: [3, 2, 0, 0, 0, 0], startFret: 1 },
      'Gadd4': { frets: [3, 2, 0, 0, 1, 3], startFret: 1 },
      'G/B':   { frets: [null, 2, 0, 0, 0, 3], startFret: 1 },
    };

    let chordColorMap = {};
    let pagingMode = false;
    let currentPage = 0;
    let pages = [];
    let showDiagrams = false;

    function getChordColor(chord) {
      // Normalize chord name for color grouping (strip bass notes and numbers except 7)
      const baseChord = chord.replace(/\/.*$/, '').replace(/[0-9]/g, (m) => m === '7' ? '7' : '');
      if (!chordColorMap[baseChord]) {
        const usedColors = Object.keys(chordColorMap).length;
        chordColorMap[baseChord] = CHORD_COLORS[usedColors % CHORD_COLORS.length];
      }
      return chordColorMap[baseChord];
    }

    function createChordSVG(chordName, color) {
      const chord = CHORD_DIAGRAMS[chordName];
      if (!chord) return null;

      const width = 48;
      const height = 60;
      const stringSpacing = 7;
      const fretSpacing = 10;
      const startX = 9;
      const startY = 12;
      const dotRadius = 2.5;

      let svg = `<svg width="${width}" height="${height}" viewBox="0 0 ${width} ${height}" xmlns="http://www.w3.org/2000/svg">`;
      
      if (chord.startFret === 1) {
        svg += `<rect x="${startX}" y="${startY - 2}" width="${stringSpacing * 5}" height="3" fill="${color}"/>`;
      } else {
        svg += `<text x="4" y="${startY + fretSpacing - 2}" font-size="7" font-family="JetBrains Mono, monospace" fill="${color}">${chord.startFret}fr</text>`;
      }

      for (let i = 0; i <= 4; i++) {
        svg += `<line x1="${startX}" y1="${startY + i * fretSpacing}" x2="${startX + stringSpacing * 5}" y2="${startY + i * fretSpacing}" stroke="${color}" stroke-width="1" opacity="0.4"/>`;
      }

      for (let i = 0; i <= 5; i++) {
        svg += `<line x1="${startX + i * stringSpacing}" y1="${startY}" x2="${startX + i * stringSpacing}" y2="${startY + fretSpacing * 4}" stroke="${color}" stroke-width="1" opacity="0.6"/>`;
      }

      if (chord.barre) {
        const barreY = startY + fretSpacing * 0.5;
        const barreStart = chord.frets.indexOf(chord.barre);
        const barreEnd = chord.frets.lastIndexOf(chord.barre);
        svg += `<rect x="${startX + barreStart * stringSpacing - dotRadius}" y="${barreY - dotRadius}" width="${(barreEnd - barreStart) * stringSpacing + dotRadius * 2}" height="${dotRadius * 2}" rx="${dotRadius}" fill="${color}"/>`;
      }

      chord.frets.forEach((fret, string) => {
        const x = startX + string * stringSpacing;
        if (fret === null) {
          svg += `<text x="${x}" y="${startY - 4}" font-size="8" font-family="JetBrains Mono" fill="${color}" text-anchor="middle">×</text>`;
        } else if (fret === 0) {
          svg += `<circle cx="${x}" cy="${startY - 5}" r="2.5" fill="none" stroke="${color}" stroke-width="1.5"/>`;
        } else if (!chord.barre || fret !== chord.barre) {
          const y = startY + (fret - (chord.startFret - 1) - 0.5) * fretSpacing;
          svg += `<circle cx="${x}" cy="${y}" r="${dotRadius}" fill="${color}"/>`;
        }
      });

      svg += '</svg>';
      return svg;
    }

    function parseLine(line) {
      const chordRegex = /\[([^\]]+)\]/g;
      const segments = [];
      const chords = [];
      let match;

      while ((match = chordRegex.exec(line)) !== null) {
        chords.push({ chord: match[1], start: match.index, end: match.index + match[0].length });
      }

      if (chords.length === 0) {
        return { segments: [{ text: line, chord: null }], hasChords: false };
      }

      let currentChord = null;
      for (let i = 0; i < line.length; ) {
        const chordAtPos = chords.find(c => c.start === i);
        
        if (chordAtPos) {
          currentChord = chordAtPos.chord;
          i = chordAtPos.end;
        } else {
          let endPos = line.length;
          for (const c of chords) {
            if (c.start > i && c.start < endPos) endPos = c.start;
          }
          const text = line.substring(i, endPos);
          if (text) {
            segments.push({ text, chord: currentChord });
            currentChord = null;
          }
          i = endPos;
        }
      }

      return { segments, hasChords: chords.length > 0 };
    }

    function buildChordLine(lineText) {
      const chordRegex = /\[([^\]]+)\]/g;
      const chordPositions = [];
      let match;
      let cleanPosition = 0;
      let lastIndex = 0;

      while ((match = chordRegex.exec(lineText)) !== null) {
        const textBefore = lineText.substring(lastIndex, match.index).replace(/\[([^\]]+)\]/g, '');
        cleanPosition += textBefore.length;
        chordPositions.push({ chord: match[1], position: cleanPosition });
        lastIndex = match.index + match[0].length;
      }

      return chordPositions;
    }

    function renderChordSheet(input) {
      chordColorMap = {};
      const lines = input.split('\n');
      const chordSheet = document.getElementById('chordSheet');
      const legend = document.getElementById('legend');
      const diagramsContainer = document.getElementById('chordDiagrams');
      
      let html = '';
      const allChords = new Set();
      const sectionRegex = /^\s*\{([^}]+)\}\s*$/;

      let currentSection = [];
      pages = [];

      for (const line of lines) {
        const sectionMatch = line.match(sectionRegex);
        
        if (sectionMatch) {
          if (currentSection.length > 0) {
            pages.push(currentSection.join(''));
            currentSection = [];
          }
          currentSection.push(`<div class="section-marker">${sectionMatch[1]}</div>`);
          continue;
        }

        if (line.trim() === '') {
          currentSection.push('<div class="line empty"></div>');
          continue;
        }

        const { segments, hasChords } = parseLine(line);
        const chordPositions = buildChordLine(line);
        chordPositions.forEach(cp => allChords.add(cp.chord));

        let chordLineHtml = '<div class="chord-line">';
        for (const cp of chordPositions) {
          const color = getChordColor(cp.chord);
          chordLineHtml += `<span class="chord" style="left: ${cp.position}ch; color: ${color};">${cp.chord}</span>`;
        }
        chordLineHtml += '</div>';

        let lyricLineHtml = '<div class="lyric-line">';
        for (const seg of segments) {
          const color = seg.chord ? getChordColor(seg.chord) : 'inherit';
          const escapedText = seg.text.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
          lyricLineHtml += `<span class="colored-text" style="color: ${color};">${escapedText}</span>`;
        }
        lyricLineHtml += '</div>';

        currentSection.push(`<div class="line">${hasChords ? chordLineHtml : ''}${lyricLineHtml}</div>`);
      }

      if (currentSection.length > 0) {
        pages.push(currentSection.join(''));
      }

      if (pagingMode) {
        html = pages.map((page, i) => 
          `<div class="page-section${i === 0 ? ' active' : ''}" data-page="${i}">${page}</div>`
        ).join('');
      } else {
        html = pages.join('');
      }

      chordSheet.innerHTML = html;

      let legendHtml = '';
      for (const chord of allChords) {
        const color = getChordColor(chord);
        legendHtml += `<span class="legend-item" style="color: ${color}; border-color: ${color}40;">${chord}</span>`;
      }
      legend.innerHTML = legendHtml;

      let diagramsHtml = '';
      for (const chord of allChords) {
        const color = getChordColor(chord);
        const svg = createChordSVG(chord, color);
        if (svg) {
          diagramsHtml += `<div class="chord-diagram">${svg}<div class="chord-diagram-label" style="color: ${color};">${chord}</div></div>`;
        }
      }
      diagramsContainer.innerHTML = diagramsHtml;

      updatePagingUI();
    }

    function updatePagingUI() {
      const indicator = document.getElementById('pageIndicator');
      const prevBtn = document.getElementById('prevPage');
      const nextBtn = document.getElementById('nextPage');
      
      indicator.textContent = `${currentPage + 1} / ${pages.length}`;
      prevBtn.disabled = currentPage === 0;
      nextBtn.disabled = currentPage === pages.length - 1;
    }

    function goToPage(pageNum) {
      if (pageNum < 0 || pageNum >= pages.length) return;
      
      document.querySelectorAll('.page-section').forEach((el, i) => {
        el.classList.toggle('active', i === pageNum);
      });
      
      currentPage = pageNum;
      updatePagingUI();
    }

    function nextPage() { goToPage(currentPage + 1); }
    function prevPage() { goToPage(currentPage - 1); }

    function togglePagingMode() {
      pagingMode = !pagingMode;
      currentPage = 0;
      
      document.getElementById('pagingBtn').classList.toggle('active', pagingMode);
      document.getElementById('pagingControls').classList.toggle('visible', pagingMode);
      document.getElementById('chordSheet').classList.toggle('paging-mode', pagingMode);
      
      const lyrics = document.getElementById('lyrics').value;
      renderChordSheet(lyrics);
    }

    function toggleDiagrams() {
      showDiagrams = !showDiagrams;
      document.getElementById('diagramsBtn').classList.toggle('active', showDiagrams);
      document.getElementById('chordDiagrams').classList.toggle('visible', showDiagrams);
    }

    function showDisplay() {
      const title = document.getElementById('title').value || 'Untitled';
      const notes = document.getElementById('notes').value;
      const lyrics = document.getElementById('lyrics').value;

      if (!lyrics.trim()) {
        alert('Please enter some lyrics with chords!');
        return;
      }

      document.getElementById('songTitle').textContent = title;
      document.getElementById('songNotes').textContent = notes;
      document.getElementById('songNotes').style.display = notes ? 'block' : 'none';
      
      currentPage = 0;
      renderChordSheet(lyrics);

      document.getElementById('editor').classList.add('hidden');
      document.getElementById('display').classList.add('active');
    }

    function showEditor() {
      document.getElementById('editor').classList.remove('hidden');
      document.getElementById('display').classList.remove('active');
    }

    function clearForm() {
      document.getElementById('title').value = '';
      document.getElementById('notes').value = '';
      document.getElementById('lyrics').value = '';
    }

    // Event listeners
    document.getElementById('displayBtn').addEventListener('click', showDisplay);
    document.getElementById('backBtn').addEventListener('click', showEditor);
    document.getElementById('clearBtn').addEventListener('click', clearForm);
    document.getElementById('pagingBtn').addEventListener('click', togglePagingMode);
    document.getElementById('diagramsBtn').addEventListener('click', toggleDiagrams);
    document.getElementById('nextPage').addEventListener('click', nextPage);
    document.getElementById('prevPage').addEventListener('click', prevPage);

    // Docs toggle
    document.getElementById('docsToggle').addEventListener('click', () => {
      document.getElementById('docs').classList.toggle('open');
    });

    // Touch/click to advance in paging mode
    document.getElementById('chordSheet').addEventListener('click', (e) => {
      if (pagingMode && !e.target.closest('.paging-controls')) {
        nextPage();
      }
    });

    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
      const displayActive = document.getElementById('display').classList.contains('active');
      
      if (e.ctrlKey && e.key === 'Enter') {
        if (!displayActive) showDisplay();
      }
      
      if (e.key === 'Escape' && displayActive) {
        showEditor();
      }
      
      if (displayActive && pagingMode) {
        if (e.key === ' ' || e.key === 'ArrowRight') {
          e.preventDefault();
          nextPage();
        }
        if (e.key === 'ArrowLeft') {
          e.preventDefault();
          prevPage();
        }
      }
    });
  </script>
</body>
</html>
